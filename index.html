<!DOCTYPE html>
<html lang="en" class=""dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albums by Maxim</title>

    <!-- Open Graph meta tags (will be updated dynamically) -->
    <meta property="og:title" content="Albums by Maxim" id="og-title">
    <meta property="og:type" content="website">
    <meta property="og:image" content="" id="og-image">
    <meta property="og:image:width" content="1200" id="og-image-width">
    <meta property="og:image:height" content="630" id="og-image-height">
    <meta property="og:url" content="" id="og-url">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in .4s linear'
                    },
                    width: {
                        '160': '160px',
                        '128': '128px'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-stone-100 dark:bg-stone-900 text-stone-800 dark:text-stone-200 text-[11px]">
    <div id="app"></div>

    <script>
        // Configuration - ImageKit endpoint
        const IMAGE_CDN_URL = 'https://ik.imagekit.io/splitfocus/albums';

        // Helper function for ImageKit transformations
        function getImageUrl(path, options = {}) {
            const {
                width = null,
                height = null,
                quality = 85,
                format = 'auto',
            } = options;

            const transformations = [];
            if (width) transformations.push(`w-${width}`);
            if (height) transformations.push(`h-${height}`);
            transformations.push(`q-${quality}`);
            transformations.push(`f-${format}`);

            const tr = transformations.join(',');
            return `${IMAGE_CDN_URL}/tr:${tr}${path}`;
        }

        // Helper function to generate srcset for responsive images
        function generateSrcset(path, sizes, quality = 85) {
            return sizes.map(width =>
                `${getImageUrl(path, { width, quality, format: 'auto' })} ${width}w`
            ).join(', ');
        }

        // Preload next 5 images for faster navigation
        function preloadNextImage() {
            const album = state.albums[state.currentAlbum];
            if (!album || state.currentPhoto >= album.photos.length) return;

            // Preload next 5 images (starting from next photo, not current)
            for (let i = 1; i <= 5; i++) {
                const photoIndex = state.currentPhoto + i - 1; // state.currentPhoto is 1-indexed, array is 0-indexed
                if (photoIndex >= album.photos.length) break;

                const nextPhoto = album.photos[photoIndex];
                if (!nextPhoto) continue;

                const nextPhotoFilename = typeof nextPhoto === 'string' ? nextPhoto : nextPhoto.filename;
                const nextPhotoPath = `/albums/${encodeURIComponent(state.currentAlbum)}/${nextPhotoFilename}`;

                // Create link element for preloading
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'image';
                link.imageSrcset = generateSrcset(nextPhotoPath, [800, 1200, 1920], 85);
                link.imageSizes = '100vw';

                document.head.appendChild(link);
            }
        }

        // Extract dominant color from image and apply ambient lighting
        function applyAmbientLighting(imgElement) {
            console.log('applyAmbientLighting called', imgElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Use small canvas for performance
            canvas.width = 50;
            canvas.height = 50;

            // Draw scaled down image
            ctx.drawImage(imgElement, 0, 0, 50, 50);

            try {
                const imageData = ctx.getImageData(0, 0, 50, 50);
                const data = imageData.data;

                let r = 0, g = 0, b = 0;
                let count = 0;

                // Calculate average color
                for (let i = 0; i < data.length; i += 4) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }

                r = Math.floor(r / count);
                g = Math.floor(g / count);
                b = Math.floor(b / count);

                console.log('Average RGB:', r, g, b);

                // Check if dark mode is active
                const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                console.log('Dark mode:', isDarkMode);

                // Convert to HSL for easier manipulation
                const hsl = rgbToHsl(r, g, b);
                console.log('Original HSL:', hsl);

                if (isDarkMode) {
                    // Dark mode: very dark, subtle colors (low lightness, low saturation)
                    hsl.s = Math.min(hsl.s * 0.3, 12); // Max 12% saturation - very muted
                    hsl.l = Math.min(hsl.l * 0.2, 10); // Max 10% lightness - very dark
                } else {
                    // Light mode: very light colors (high lightness, moderate saturation)
                    hsl.s = Math.min(hsl.s * 0.5, 25); // Max 25% saturation
                    hsl.l = Math.max(98 - (hsl.l * 0.15), 88); // Range 88-98% lightness
                }

                console.log('Adjusted HSL:', hsl);
                const color = `hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
                console.log('Applying color:', color);

                // Apply color to body with smooth transition (use !important to override Tailwind classes)
                document.body.style.transition = 'background-color 0.4s ease';
                document.body.style.setProperty('background-color', color, 'important');

                // Apply to overlay if it exists (no need to set transition, it has transition-all in class)
                const photoOverlay = document.getElementById('photo-overlay');
                if (photoOverlay) {
                    photoOverlay.style.setProperty('background-color', color, 'important');
                }

                console.log('Body background-color after set:', document.body.style.backgroundColor);
            } catch (e) {
                // CORS or other errors - silently fail
                console.warn('Could not extract color for ambient lighting:', e);
            }
        }

        // Helper to convert RGB to HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        }

        // Reset ambient lighting when returning to index
        function resetAmbientLighting() {
            document.body.style.transition = 'background-color 0.4s ease';
            document.body.style.backgroundColor = '';
        }

        let state = {
            view: 'index',
            currentAlbum: null,
            currentPhoto: 1,
            albums: {},
            sortBy: 'date-desc', // 'name-asc', 'name-desc', 'date-desc', 'date-asc', 'random'
            overlayOpen: false,
            searchQuery: '',
            selectedAlbumIndex: -1, // -1 means no album selected, 0+ means album at that index is selected
            navVisible: true, // Track navigation visibility
            selectedOverlayIndex: -1 // -1 means no photo selected in overlay, 1+ means photo number selected
        };

        // Parse URL hash to restore state
        function parseHash() {
            const hash = window.location.hash.slice(1); // Remove the #
            if (!hash) {
                // No hash means we're at the index
                state.view = 'index';
                state.currentAlbum = null;
                state.currentPhoto = 1;
                return;
            }

            const parts = hash.split('/');
            if (parts.length === 2) {
                const [encodedAlbumId, photoNum] = parts;
                const albumId = decodeURIComponent(encodedAlbumId);
                const photoNumber = parseInt(photoNum, 10);

                if (state.albums[albumId] && photoNumber > 0) {
                    state.currentAlbum = albumId;
                    state.currentPhoto = Math.min(photoNumber, state.albums[albumId].photos.length);
                    state.view = 'viewer';
                }
            }
        }

        // Update URL hash when state changes
        function updateHash() {
            if (state.view === 'viewer' && state.currentAlbum) {
                window.location.hash = `${encodeURIComponent(state.currentAlbum)}/${state.currentPhoto}`;
            } else {
                window.location.hash = '';
            }
        }

        // Load albums from folders
        async function loadAlbums() {
            try {
                // Fetch the albums list
                const response = await fetch('./albums/albums.json');
                const albumsList = await response.json();

                // Load each album's photos
                for (const albumId of albumsList.albums) {
                    try {
                        const photosResponse = await fetch(`./albums/${encodeURIComponent(albumId)}/photos.json`);
                        const photosData = await photosResponse.json();
                        state.albums[albumId] = {
                            name: photosData.name || albumId,
                            photos: photosData.photos,
                            created: photosData.created || null
                        };
                    } catch (e) {
                        console.error(`Failed to load album ${albumId}:`, e);
                    }
                }

                parseHash(); // Check URL hash after loading albums
                render();
            } catch (e) {
                console.error('Failed to load albums:', e);
                document.getElementById('app').innerHTML = '<p>Error loading albums. Make sure /albums/albums.json exists.</p>';
            }
        }

        function render() {
            const app = document.getElementById('app');

            if (state.view === 'index') {
                // Reset ambient lighting when returning to index
                resetAmbientLighting();

                // Set page title and meta tags
                document.title = 'Albums by Maxim';
                document.getElementById('og-title').setAttribute('content', 'Albums by Maxim');
                document.getElementById('og-image').setAttribute('content', '');
                document.getElementById('og-image-width').setAttribute('content', '1200');
                document.getElementById('og-image-height').setAttribute('content', '630');
                document.getElementById('og-url').setAttribute('content', window.location.href);

                app.innerHTML = `
                    <div>
                        <div class="p-6 grid md:gap-x-10 gap-x-6 sm:gap-y-0 gap-y-6 lg:grid-cols-6 md:grid-cols-4 sm:grid-cols-3 grid-cols-2 border-b border-stone-800 dark:border-stone-400">
                          <div class="flex space-x-1 group h-fit">
                            <h1><a href="/photo-albums" class="hover:underline">Albums</a></h1>
                            <span class="text-stone-500 sm:opacity-0 group-hover:opacity-100">(${Object.keys(state.albums).length})</span>
                          </div>
                          <div class="lg:col-span-4 md:col-span-2 col-span-1">
                            <input id="search-input" type="text" placeholder="Search" value="${state.searchQuery}" class="w-full bg-transparent focus:outline-none focus:underline placeholder-stone-800 dark:placeholder-stone-200"/>
                          </div>
                          <div class="space-y-1 sm:col-span-1 sm:col-start-auto col-start-2">
                            <span>Sort by:</span>
                            <div>
                                <button id="sort-date-desc" class="block ${state.sortBy === 'date-desc' ? 'underline' : 'hover:underline'}">Newest</button>
                                <button id="sort-date-asc" class="block ${state.sortBy === 'date-asc' ? 'underline' : 'hover:underline'}">Oldest</button>
                                <button id="sort-name-asc" class="block ${state.sortBy === 'name-asc' ? 'underline' : 'hover:underline'}">Name (A-Z)</button>
                                <button id="sort-name-desc" class="block ${state.sortBy === 'name-desc' ? 'underline' : 'hover:underline'}">Name (Z-A)</button>
                                <button id="sort-random" class="block ${state.sortBy === 'random' ? 'underline' : 'hover:underline'}">Random</button>
                            </div>
                          </div>
                        </div>
                        <ul id="album-list" class="px-6 py-12 md:gap-x-10 gap-x-6 gap-y-12 grid lg:grid-cols-6 md:grid-cols-4 sm:grid-cols-3 grid-cols-1 items-end"></ul>
                        <div class="p-6 border-t border-stone-800 dark:border-stone-400 grid md:gap-x-10 gap-x-6 sm:gap-y-0 gap-y-6 lg:grid-cols-6 md:grid-cols-4 sm:grid-cols-3 grid-cols-2">
                          <span class="lg:col-span-5 md:col-span-3 col-span-1 text-stone-500">(${Object.values(state.albums).reduce((total, album) => total + album.photos.length, 0)})</span>
                          <span class="text-stone-500">All Rights Reserved, 2026 ©</span>
                        </div>
                    </div>
                `;

                const list = document.getElementById('album-list');

                if (Object.keys(state.albums).length === 0) {
                    list.innerHTML = '<li>No albums found</li>';
                    return;
                }

                // Add search input handler
                const searchInput = document.getElementById('search-input');
                searchInput.oninput = (e) => {
                    state.searchQuery = e.target.value;
                    filterAlbums();
                };

                // Add sorting button handlers
                document.getElementById('sort-name-asc').onclick = () => {
                    state.sortBy = 'name-asc';
                    render();
                };
                document.getElementById('sort-name-desc').onclick = () => {
                    state.sortBy = 'name-desc';
                    render();
                };
                document.getElementById('sort-date-desc').onclick = () => {
                    state.sortBy = 'date-desc';
                    render();
                };
                document.getElementById('sort-date-asc').onclick = () => {
                    state.sortBy = 'date-asc';
                    render();
                };
                document.getElementById('sort-random').onclick = () => {
                    state.sortBy = 'random';
                    render();
                };

                // Sort albums based on current sort option
                let albumEntries = Object.entries(state.albums);

                if (state.sortBy === 'random') {
                    // Fisher-Yates shuffle algorithm
                    for (let i = albumEntries.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [albumEntries[i], albumEntries[j]] = [albumEntries[j], albumEntries[i]];
                    }
                } else {
                    albumEntries.sort((a, b) => {
                        const [idA, albumA] = a;
                        const [idB, albumB] = b;

                        if (state.sortBy === 'name-asc') {
                            return albumA.name.localeCompare(albumB.name); // A-Z
                        } else if (state.sortBy === 'name-desc') {
                            return albumB.name.localeCompare(albumA.name); // Z-A
                        } else if (state.sortBy === 'date-desc') {
                            const dateA = albumA.created ? new Date(albumA.created) : new Date(0);
                            const dateB = albumB.created ? new Date(albumB.created) : new Date(0);
                            return dateB - dateA; // Newest first
                        } else if (state.sortBy === 'date-asc') {
                            const dateA = albumA.created ? new Date(albumA.created) : new Date(0);
                            const dateB = albumB.created ? new Date(albumB.created) : new Date(0);
                            return dateA - dateB; // Oldest first
                        }
                        return 0;
                    });
                }

                albumEntries.forEach(([id, album], index) => {
                    const li = document.createElement('li');
                    li.className = 'group';
                    li.dataset.albumId = id;
                    li.dataset.albumName = album.name.toLowerCase();
                    li.dataset.albumIndex = index;
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'focus:outline-none';

                    // Add cover image if available
                    if (album.photos && album.photos.length > 0) {
                        // Get first photo (support both string and object format)
                        const firstPhoto = album.photos[0];
                        const firstPhotoFilename = typeof firstPhoto === 'string' ? firstPhoto : firstPhoto.filename;

                        // Get dimensions if available
                        const coverWidth = (typeof firstPhoto === 'object' && firstPhoto.width) ? firstPhoto.width : null;
                        const coverHeight = (typeof firstPhoto === 'object' && firstPhoto.height) ? firstPhoto.height : null;
                        const coverAspectRatio = (coverWidth && coverHeight) ? `${coverWidth} / ${coverHeight}` : 'auto';

                        // Create container with aspect ratio
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative mb-4';
                        imgContainer.style.aspectRatio = coverAspectRatio;

                        // Add background placeholder
                        const placeholder = document.createElement('div');
                        placeholder.className = 'absolute inset-0 bg-stone-300 dark:bg-stone-800 opacity-0';
                        imgContainer.appendChild(placeholder);

                        // Add staggered fade-in animation to placeholder
                        setTimeout(() => {
                            placeholder.classList.remove('opacity-0');
                            placeholder.classList.add('animate-fade-in');
                        }, index * 100);

                        const img = document.createElement('img');
                        img.className = 'relative z-10 w-full h-full object-contain group-hover:outline group-hover:outline-stone-800 dark:group-hover:outline-stone-100 outline outline-transparent opacity-0';
                        img.dataset.albumIndex = index;

                        // Store data for lazy loading
                        img.dataset.srcset = generateSrcset(`/albums/${encodeURIComponent(id)}/${firstPhotoFilename}`, [200, 400, 600, 800], 80);
                        img.dataset.sizes = '(max-width: 640px) 50vw, (max-width: 768px) 33vw, 16vw';
                        img.dataset.src = getImageUrl(`/albums/${encodeURIComponent(id)}/${firstPhotoFilename}`, {
                            width: 400,
                            quality: 80,
                            format: 'auto'
                        });
                        img.alt = album.name;
                        img.decoding = 'async';

                        // Add staggered fade-in animation after image loads (with 600ms base delay)
                        img.onload = () => {
                            setTimeout(() => {
                                img.classList.remove('opacity-0');
                                img.classList.add('animate-fade-in');
                            }, 600 + (index * 100)); // 600ms base delay + 100ms stagger per item
                        };

                        imgContainer.appendChild(img);
                        a.appendChild(imgContainer);
                    }
                    
                    const infoWrapper = document.createElement('div');
                    infoWrapper.className = 'flex space-x-1'

                    const title = document.createElement('div');
                    title.textContent = album.name;
                    title.className = 'group-hover:underline';
                    infoWrapper.appendChild(title);


                    // if (album.created) {
                    //     const date = document.createElement('div');
                    //     const dateObj = new Date(album.created);
                    //     date.textContent = dateObj.toLocaleDateString('en-US', {
                    //         year: 'numeric',
                    //         month: 'short',
                    //         day: 'numeric'
                    //     });
                    //     infoWrapper.appendChild(date);
                    // }

                    const count = document.createElement('div');
                    count.className = 'text-stone-500 sm:opacity-0 group-hover:opacity-100'
                    count.textContent = `(${album.photos.length})`;
                    infoWrapper.appendChild(count);

                    a.appendChild(infoWrapper);
                    
                    a.onclick = (e) => {
                        e.preventDefault();
                        openAlbum(id);
                    };

                    // Preload first 3 images on hover
                    a.onmouseenter = () => {
                        if (album.photos && album.photos.length > 0) {
                            const photosToPreload = album.photos.slice(0, 3);
                            photosToPreload.forEach(photo => {
                                const photoFilename = typeof photo === 'string' ? photo : photo.filename;
                                const link = document.createElement('link');
                                link.rel = 'prefetch';
                                link.as = 'image';
                                link.imageSrcset = generateSrcset(`/albums/${encodeURIComponent(id)}/${photoFilename}`, [800, 1200, 1920, 2560, 3840], 100);
                                link.imageSizes = '100vw';
                                document.head.appendChild(link);
                            });
                        }
                    };

                    li.appendChild(a);
                    list.appendChild(li);
                });

                // Lazy load images with Intersection Observer
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.srcset = img.dataset.srcset;
                            img.sizes = img.dataset.sizes;
                            img.src = img.dataset.src;
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px'
                });

                document.querySelectorAll('#album-list img').forEach(img => {
                    imageObserver.observe(img);
                });

                // Always apply search filter to ensure correct visibility
                filterAlbums();

                // Update keyboard selection visual state if needed
                updateAlbumSelectionVisual();
            } else {
                const album = state.albums[state.currentAlbum];
                const currentPhoto = album.photos[state.currentPhoto - 1];
                const currentPhotoFilename = typeof currentPhoto === 'string' ? currentPhoto : currentPhoto.filename;
                const isLastPhoto = state.currentPhoto >= album.photos.length;

                // Get dimensions if available
                const photoWidth = (currentPhoto && typeof currentPhoto === 'object' && currentPhoto.width) ? currentPhoto.width : null;
                const photoHeight = (currentPhoto && typeof currentPhoto === 'object' && currentPhoto.height) ? currentPhoto.height : null;

                // Set page title and meta tags
                document.title = `${album.name} | Albums by Maxim`;
                document.getElementById('og-title').setAttribute('content', `${album.name} | Albums by Maxim`);

                // Set og:image to the current photo
                const currentPhotoUrl = getImageUrl(`/albums/${encodeURIComponent(state.currentAlbum)}/${currentPhotoFilename}`, {
                    width: 1200,
                    quality: 85,
                    format: 'auto'
                });
                document.getElementById('og-image').setAttribute('content', currentPhotoUrl);

                // Set og:image dimensions (use actual photo dimensions or defaults)
                if (photoWidth && photoHeight) {
                    // Scale to max width of 1200 while maintaining aspect ratio
                    const scale = Math.min(1200 / photoWidth, 1);
                    const ogWidth = Math.round(photoWidth * scale);
                    const ogHeight = Math.round(photoHeight * scale);
                    document.getElementById('og-image-width').setAttribute('content', ogWidth.toString());
                    document.getElementById('og-image-height').setAttribute('content', ogHeight.toString());
                } else {
                    // Default to 1200x630 (recommended OG image size)
                    document.getElementById('og-image-width').setAttribute('content', '1200');
                    document.getElementById('og-image-height').setAttribute('content', '630');
                }

                document.getElementById('og-url').setAttribute('content', window.location.href);
                const aspectRatio = (photoWidth && photoHeight) ? `${photoWidth} / ${photoHeight}` : 'auto';
                const isPortrait = (photoWidth && photoHeight) ? photoHeight > photoWidth : false;
                const orientationClass = isPortrait ? 'sm:h-[100cqmin] sm:w-auto w-[100cqmin] max-h-full max-w-full' : 'w-[110cqmin] max-h-full max-w-full';

                const photoPath = `/albums/${encodeURIComponent(state.currentAlbum)}/${currentPhotoFilename}`;

                app.innerHTML = `
                    <div>
                        <!-- Loading progress bar -->
                        <div class="fixed top-0 left-0 w-full h-px z-50">
                            <div id="loading-bar" class="h-full bg-black/5 dark:bg-white/10 transition-all duration-150" style="width: 0%"></div>
                        </div>

                        <div id="top-nav" class="absolute top-0 w-full flex place-content-between px-6 py-6 z-20 transition-opacity duration-[800ms]">
                            <div class="flex space-x-1">
                              <button id="back-btn" class="hover:underline block">
                                Albums
                              </button>
                              <span class="text-stone-500">/</span>
                              <button id="album-name-btn" class="hover:underline"> ${album.name}</button>
                            </div>
                            <button id="photo-count-btn" class="text-stone-500 hover:underline">
                                (${state.currentPhoto}
                                <span class="text-stone-500">/</span>
                                ${album.photos.length}) 
                                <span class="ml-1">⁝</span>
                            </button>
                        </div>
                        <div class="w-full h-dvh md:p-24 sm:p-12 p-6">
                          <div class="w-full h-full relative flex items-center justify-center">
                            <div class="relative ${orientationClass}" style="aspect-ratio: ${aspectRatio}; container-type: size;">
                              <div class="w-full h-full bg-black/5 dark:bg-white/10"></div>
                              <img
                                  class="absolute inset-0 w-full h-full object-contain opacity-0"
                                  id="photo-img"
                                  srcset="${generateSrcset(photoPath, [800, 1200, 1920], 85)}"
                                  sizes="100vw"
                                  src="${getImageUrl(photoPath, { width: 1920, quality: 85, format: 'auto' })}"
                                  alt="Photo ${state.currentPhoto}"
                                  style="cursor: pointer"
                                  loading="eager"
                                  decoding="async"
                                  crossorigin="anonymous"
                              />
                            </div>
                          </div>
                        </div>

                        <!-- Photo navigation overlay -->
                        <div id="photo-overlay-backdrop" class="fixed inset-0 bg-transparent bg-opacity-0 transition-opacity duration-400 pointer-events-none z-40"></div>
                        <div id="photo-overlay" class="fixed top-0 right-0 h-full w-128 sm:w-160 transform translate-x-full transition-all duration-400 z-50 overflow-y-auto p-6 space-y-6">
                        </div>

                        <!-- ${isLastPhoto ? '<p>End of album - click photo to return</p>' : ''} -->
                    </div>
                `;

                document.getElementById('back-btn').onclick = backToIndex;
                document.getElementById('album-name-btn').onclick = toggleFullscreen;

                // Top navigation auto-hide functionality
                const topNav = document.getElementById('top-nav');
                let navHideTimer = null;

                function showNav() {
                    state.navVisible = true;
                    topNav.style.opacity = '1';

                    // Clear existing timer
                    if (navHideTimer) {
                        clearTimeout(navHideTimer);
                    }

                    // Set timer to hide after 2 seconds
                    navHideTimer = setTimeout(() => {
                        state.navVisible = false;
                        topNav.style.opacity = '0';
                    }, 2000);
                }

                function hideNavImmediate() {
                    if (navHideTimer) {
                        clearTimeout(navHideTimer);
                    }
                    state.navVisible = false;
                    topNav.style.opacity = '0';
                }

                // Show nav on hover
                topNav.addEventListener('mouseenter', () => {
                    showNav();
                });

                // Click handler for showing nav (attached to container, not document)
                const clickHandler = (e) => {
                    const photoImg = document.getElementById('photo-img');
                    const overlay = document.getElementById('photo-overlay');

                    // Don't show nav if clicking on image or inside overlay
                    if (e.target !== photoImg && !overlay.contains(e.target) && !photoImg.contains(e.target)) {
                        showNav();
                    }
                };

                // Attach to the app container instead of document
                document.getElementById('app').addEventListener('click', clickHandler);

                // Initialize: show nav and start timer, unless it was already hidden
                if (state.navVisible) {
                    showNav();
                } else {
                    topNav.style.opacity = '0';
                }

                // Photo overlay functionality
                const photoOverlay = document.getElementById('photo-overlay');
                const photoOverlayBackdrop = document.getElementById('photo-overlay-backdrop');
                let overlayOpen = false;

                // Populate overlay with all photos
                album.photos.forEach((photo, index) => {
                    const photoFilename = typeof photo === 'string' ? photo : photo.filename;
                    const photoIndex = index + 1;
                    const isCurrentPhoto = photoIndex === state.currentPhoto;

                    const photoItem = document.createElement('div');
                    photoItem.className = `cursor-pointer ${isCurrentPhoto ? 'outline outline-stone-800 dark:outline-stone-100' : ''}`;
                    photoItem.id = `overlay-photo-${photoIndex}`;

                    const img = document.createElement('img');
                    img.className = 'w-full h-auto hover:outline hover:outline-stone-800 dark:hover:outline-stone-100 outline outline-transparent';
                    img.src = getImageUrl(`/albums/${encodeURIComponent(state.currentAlbum)}/${photoFilename}`, {
                        width: 200,
                        quality: 80,
                        format: 'auto'
                    });
                    img.alt = `Photo ${photoIndex}`;

                    photoItem.appendChild(img);
                    photoItem.onclick = (e) => {
                        e.stopPropagation();
                        state.currentPhoto = photoIndex;
                        state.overlayOpen = false; // Reset overlay state when navigating
                        // Don't change navVisible - preserve current state
                        updateHash();
                        render();
                    };

                    photoOverlay.appendChild(photoItem);
                });

                // Toggle overlay
                const toggleOverlay = (show) => {
                    overlayOpen = show;
                    state.overlayOpen = show;
                    if (show) {
                        photoOverlay.classList.remove('translate-x-full');
                        photoOverlayBackdrop.classList.remove('bg-opacity-0', 'pointer-events-none');
                        photoOverlayBackdrop.classList.add('bg-opacity-0');

                        // Initialize keyboard selection to current photo
                        state.selectedOverlayIndex = state.currentPhoto;
                        updateOverlaySelectionVisual();

                        // Scroll current photo into view (centered)
                        setTimeout(() => {
                            const currentPhotoEl = document.getElementById(`overlay-photo-${state.currentPhoto}`);
                            if (currentPhotoEl) {
                                currentPhotoEl.scrollIntoView({ behavior: 'auto', block: 'center' });
                            }
                        }, 50);
                    } else {
                        photoOverlay.classList.add('translate-x-full');
                        photoOverlayBackdrop.classList.add('bg-opacity-0', 'pointer-events-none');
                        photoOverlayBackdrop.classList.remove('bg-opacity-50');
                        // Reset selection when closing
                        state.selectedOverlayIndex = -1;
                    }
                };

                document.getElementById('photo-count-btn').onclick = () => toggleOverlay(true);
                photoOverlayBackdrop.onclick = () => toggleOverlay(false);

                const photoImg = document.getElementById('photo-img');
                const loadingBar = document.getElementById('loading-bar');

                // Optimized: let browser load natively, simulate smooth progress
                let progress = 0;
                let progressSpeed = 15; // Start fast

                const progressInterval = setInterval(() => {
                    // Slow down as we get closer to 90%
                    if (progress > 70) progressSpeed = 3;
                    else if (progress > 50) progressSpeed = 8;

                    progress += progressSpeed;
                    if (progress > 90) progress = 90;
                    loadingBar.style.width = `${progress}%`;
                }, 50);

                // Complete on actual image load
                photoImg.onload = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';

                    setTimeout(() => {
                        loadingBar.style.opacity = '0';
                    }, 150);

                    photoImg.classList.remove('opacity-0');
                    photoImg.classList.add('animate-fade-in');

                    // Store current photo element and apply ambient lighting
                    currentPhotoElement = photoImg;
                    applyAmbientLighting(photoImg);
                };

                photoImg.onerror = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';
                    loadingBar.classList.remove('bg-black');
                    loadingBar.classList.add('bg-red-500');
                };

                photoImg.onclick = (e) => {
                    e.stopPropagation();

                    // Get click position relative to image
                    const rect = photoImg.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const imageWidth = rect.width;
                    const clickPercentage = clickX / imageWidth;

                    // Left 30% - go to previous photo
                    if (clickPercentage < 0.30) {
                        if (state.currentPhoto === 1) {
                            backToIndex();
                        } else {
                            state.currentPhoto--;
                            updateHash();
                            render();
                        }
                    }
                    // Right 70% - go to next photo
                    else {
                        if (state.currentPhoto >= album.photos.length) {
                            backToIndex();
                        } else {
                            nextPhoto();
                        }
                    }
                };

                // Preload the next image for instant navigation
                preloadNextImage();
            }
        }

        function openAlbum(albumId) {
            state.currentAlbum = albumId;
            state.currentPhoto = 1;
            state.view = 'viewer';
            state.navVisible = true; // Reset nav to visible when opening album
            updateHash();
            render();
        }

        function nextPhoto() {
            const album = state.albums[state.currentAlbum];
            if (state.currentPhoto < album.photos.length) {
                state.currentPhoto++;
                updateHash();
                render();
            }
        }

        function backToIndex() {
            state.view = 'index';
            state.currentAlbum = null;
            state.currentPhoto = 1;
            state.selectedAlbumIndex = -1; // Reset keyboard selection
            state.navVisible = true; // Reset nav visibility
            updateHash();
            render();
        }

        function filterAlbums() {
            const query = state.searchQuery.toLowerCase();
            const albumItems = document.querySelectorAll('#album-list li');

            albumItems.forEach(li => {
                const albumId = li.dataset.albumId.toLowerCase();
                const albumName = li.dataset.albumName;

                if (!query || albumName.includes(query) || albumId.includes(query)) {
                    li.classList.remove('hidden');
                } else {
                    li.classList.add('hidden');
                }
            });
        }

        function updateAlbumSelectionVisual() {
            const albumItems = document.querySelectorAll('#album-list li');
            albumItems.forEach((li) => {
                const img = li.querySelector('img');
                const count = li.querySelector('.text-stone-500');
                const albumIndex = parseInt(li.dataset.albumIndex);

                if (albumIndex === state.selectedAlbumIndex) {
                    // Add outline to image
                    if (img) {
                        img.classList.remove('outline-transparent');
                        img.classList.add('outline', 'outline-stone-800', 'dark:outline-stone-100');
                    }
                    // Show count
                    if (count) {
                        count.classList.remove('sm:opacity-0');
                        count.classList.add('opacity-100');
                    }
                } else {
                    // Remove outline from image
                    if (img) {
                        img.classList.add('outline-transparent');
                        img.classList.remove('outline-stone-800', 'dark:outline-stone-100');
                    }
                    // Hide count
                    if (count) {
                        count.classList.add('sm:opacity-0');
                        count.classList.remove('opacity-100');
                    }
                }
            });
        }

        function updateOverlaySelectionVisual() {
            const photoItems = document.querySelectorAll('#photo-overlay > div[id^="overlay-photo-"]');
            photoItems.forEach((item) => {
                const photoNum = parseInt(item.id.replace('overlay-photo-', ''));
                if (photoNum === state.selectedOverlayIndex) {
                    item.classList.remove('outline-transparent');
                    item.classList.add('outline', 'outline-stone-800', 'dark:outline-stone-100');
                    // Remove hover outline classes to prevent conflict
                    const img = item.querySelector('img');
                    if (img) {
                        img.classList.remove('hover:outline', 'hover:outline-stone-800', 'dark:hover:outline-stone-100');
                    }
                } else {
                    // Remove selection outline completely
                    item.classList.remove('outline', 'outline-stone-800', 'dark:outline-stone-100');
                    item.classList.add('outline-transparent');
                    // Restore hover classes
                    const img = item.querySelector('img');
                    if (img) {
                        img.classList.add('hover:outline', 'hover:outline-stone-800', 'dark:hover:outline-stone-100');
                    }
                }
            });
        }

        function getVisibleAlbumItems() {
            const albumItems = document.querySelectorAll('#album-list li');
            return Array.from(albumItems).filter(li => !li.classList.contains('hidden'));
        }

        function getGridColumns() {
            // Determine number of columns based on current viewport
            const width = window.innerWidth;
            if (width >= 1024) return 6; // lg:grid-cols-6
            if (width >= 768) return 4;  // md:grid-cols-4
            if (width >= 640) return 3;  // sm:grid-cols-3
            return 1;                     // grid-cols-1
        }

        function navigateAlbumSelection(direction, isVertical = false) {
            const visibleAlbums = getVisibleAlbumItems();
            if (visibleAlbums.length === 0) return;

            if (state.selectedAlbumIndex === -1) {
                // No album selected yet, select first
                state.selectedAlbumIndex = parseInt(visibleAlbums[0].dataset.albumIndex);
            } else {
                // Find current position in visible albums
                const currentVisibleIndex = visibleAlbums.findIndex(
                    li => parseInt(li.dataset.albumIndex) === state.selectedAlbumIndex
                );

                if (currentVisibleIndex === -1) {
                    // Current selection is filtered out, select first visible
                    state.selectedAlbumIndex = parseInt(visibleAlbums[0].dataset.albumIndex);
                } else {
                    let newVisibleIndex;

                    if (isVertical) {
                        // Vertical navigation (up/down) - jump by number of columns
                        const columns = getGridColumns();
                        newVisibleIndex = currentVisibleIndex + (direction * columns);

                        // Wrap around if out of bounds
                        if (newVisibleIndex < 0) {
                            // Going up from top - wrap to bottom, same column if possible
                            const column = currentVisibleIndex % columns;
                            const lastRowStart = Math.floor((visibleAlbums.length - 1) / columns) * columns;
                            newVisibleIndex = lastRowStart + column;
                            if (newVisibleIndex >= visibleAlbums.length) {
                                newVisibleIndex = visibleAlbums.length - 1;
                            }
                        } else if (newVisibleIndex >= visibleAlbums.length) {
                            // Going down from bottom - wrap to top, same column if possible
                            const column = currentVisibleIndex % columns;
                            newVisibleIndex = column;
                        }
                    } else {
                        // Horizontal navigation (left/right) - move by 1
                        newVisibleIndex = currentVisibleIndex + direction;
                        if (newVisibleIndex < 0) {
                            newVisibleIndex = visibleAlbums.length - 1; // Wrap to last
                        } else if (newVisibleIndex >= visibleAlbums.length) {
                            newVisibleIndex = 0; // Wrap to first
                        }
                    }

                    state.selectedAlbumIndex = parseInt(visibleAlbums[newVisibleIndex].dataset.albumIndex);
                }
            }

            updateAlbumSelectionVisual();

            // Scroll selected album into view
            const selectedLi = visibleAlbums.find(
                li => parseInt(li.dataset.albumIndex) === state.selectedAlbumIndex
            );
            if (selectedLi) {
                selectedLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function openSelectedAlbum() {
            if (state.selectedAlbumIndex === -1) return;

            const albumItems = document.querySelectorAll('#album-list li');
            const selectedLi = Array.from(albumItems).find(
                li => parseInt(li.dataset.albumIndex) === state.selectedAlbumIndex
            );

            if (selectedLi) {
                const albumId = selectedLi.dataset.albumId;
                openAlbum(albumId);
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            parseHash();
            render();
        });

        // Fullscreen functionality
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Enter fullscreen
                document.documentElement.requestFullscreen().catch(err => {
                    console.warn('Could not enter fullscreen:', err);
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen();
            }
        }

        // Handle keyboard navigation
        window.addEventListener('keydown', (e) => {
            if (state.view === 'index') {
                // Album list navigation
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateAlbumSelection(1, false);
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateAlbumSelection(-1, false);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateAlbumSelection(1, true);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateAlbumSelection(-1, true);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    openSelectedAlbum();
                } else if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    toggleFullscreen();
                } else if (e.key === 'i' || e.key === 'I') {
                    e.preventDefault();
                    backToIndex();
                }
            } else if (state.view === 'viewer') {
                // Photo viewer navigation
                const album = state.albums[state.currentAlbum];

                // Spacebar toggles overlay
                if (e.key === ' ') {
                    e.preventDefault();
                    const photoOverlay = document.getElementById('photo-overlay');
                    const isOpen = !photoOverlay.classList.contains('translate-x-full');

                    if (isOpen) {
                        // Close overlay
                        photoOverlay.classList.add('translate-x-full');
                        const backdrop = document.getElementById('photo-overlay-backdrop');
                        backdrop.classList.add('bg-opacity-0', 'pointer-events-none');
                        state.overlayOpen = false;
                        state.selectedOverlayIndex = -1;
                    } else {
                        // Open overlay
                        photoOverlay.classList.remove('translate-x-full');
                        const backdrop = document.getElementById('photo-overlay-backdrop');
                        backdrop.classList.remove('bg-opacity-0', 'pointer-events-none');
                        state.overlayOpen = true;
                        state.selectedOverlayIndex = state.currentPhoto;
                        updateOverlaySelectionVisual();

                        // Scroll selected photo into view
                        setTimeout(() => {
                            const selectedPhotoEl = document.getElementById(`overlay-photo-${state.selectedOverlayIndex}`);
                            if (selectedPhotoEl) {
                                selectedPhotoEl.scrollIntoView({ behavior: 'auto', block: 'center' });
                            }
                        }, 50);
                    }
                } else if (state.overlayOpen && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
                    // Navigate overlay with arrow keys when open
                    e.preventDefault();
                    const direction = e.key === 'ArrowDown' ? 1 : -1;
                    const newIndex = state.selectedOverlayIndex + direction;

                    // Clamp to valid range
                    if (newIndex >= 1 && newIndex <= album.photos.length) {
                        state.selectedOverlayIndex = newIndex;
                        updateOverlaySelectionVisual();

                        // Auto-scroll selected photo into view
                        const selectedPhotoEl = document.getElementById(`overlay-photo-${state.selectedOverlayIndex}`);
                        if (selectedPhotoEl) {
                            selectedPhotoEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                } else if (state.overlayOpen && e.key === 'Enter') {
                    // Navigate to selected photo in overlay
                    e.preventDefault();
                    if (state.selectedOverlayIndex >= 1 && state.selectedOverlayIndex <= album.photos.length) {
                        state.currentPhoto = state.selectedOverlayIndex;
                        state.overlayOpen = false;
                        state.selectedOverlayIndex = -1;
                        updateHash();
                        render();
                    }
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (state.currentPhoto >= album.photos.length) {
                        backToIndex();
                    } else {
                        nextPhoto();
                    }
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (state.currentPhoto === 1) {
                        backToIndex();
                    } else {
                        state.currentPhoto--;
                        updateHash();
                        render();
                    }
                } else if (e.key === 'ArrowDown' && !state.overlayOpen) {
                    e.preventDefault();
                    backToIndex();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // Close overlay if open, otherwise exit fullscreen or back to index
                    if (state.overlayOpen) {
                        const photoOverlay = document.getElementById('photo-overlay');
                        photoOverlay.classList.add('translate-x-full');
                        const backdrop = document.getElementById('photo-overlay-backdrop');
                        backdrop.classList.add('bg-opacity-0', 'pointer-events-none');
                        state.overlayOpen = false;
                        state.selectedOverlayIndex = -1;
                    } else if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        backToIndex();
                    }
                } else if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    toggleFullscreen();
                } else if (e.key === 'i' || e.key === 'I') {
                    e.preventDefault();
                    backToIndex();
                } else if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    // Return to first image in album
                    state.currentPhoto = 1;
                    updateHash();
                    render();
                }
            }
        });

        // Handle dark mode changes and reapply ambient lighting
        let currentPhotoElement = null;
        const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkModeMediaQuery.addEventListener('change', () => {
            if (currentPhotoElement && state.view === 'viewer') {
                applyAmbientLighting(currentPhotoElement);
            }
        });

        // Handle touch/swipe gestures
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        window.addEventListener('touchstart', (e) => {
            if (state.view !== 'viewer') return;
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        window.addEventListener('touchend', (e) => {
            if (state.view !== 'viewer') return;

            // Disable swipe navigation when overlay is open
            if (state.overlayOpen) return;

            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;

            const album = state.albums[state.currentAlbum];
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Minimum swipe distance to trigger action (50px)
            const minSwipeDistance = 50;

            // Determine if horizontal or vertical swipe
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe right (previous photo or back to index)
                        if (state.currentPhoto === 1) {
                            backToIndex();
                        } else {
                            state.currentPhoto--;
                            updateHash();
                            render();
                        }
                    } else {
                        // Swipe left (next photo or back to index)
                        if (state.currentPhoto >= album.photos.length) {
                            backToIndex();
                        } else {
                            nextPhoto();
                        }
                    }
                }
            } else {
                // Vertical swipe
                if (Math.abs(deltaY) > minSwipeDistance) {
                    // Check if in fullscreen mode
                    if (document.fullscreenElement) {
                        // Exit fullscreen on any vertical swipe (up or down)
                        document.exitFullscreen();
                    } else if (deltaY < 0) {
                        // Swipe up - back to index (only when not in fullscreen)
                        backToIndex();
                    }
                }
            }
        });

        // Initial load
        loadAlbums();
    </script>
</body>
</html>
