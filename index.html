<!DOCTYPE html>
<html lang="en" class=""dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Albums</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in .6s ease-in'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-stone-100 dark:bg-stone-900 text-stone-800 dark:text-stone-200 text-[11px]">
    <div id="app"></div>

    <script>
        // Configuration - ImageKit endpoint
        const IMAGE_CDN_URL = 'https://ik.imagekit.io/splitfocus/albums';

        // Helper function for ImageKit transformations
        function getImageUrl(path, options = {}) {
            const {
                width = null,
                height = null,
                quality = 85,
                format = 'auto',
            } = options;

            const transformations = [];
            if (width) transformations.push(`w-${width}`);
            if (height) transformations.push(`h-${height}`);
            transformations.push(`q-${quality}`);
            transformations.push(`f-${format}`);

            const tr = transformations.join(',');
            return `${IMAGE_CDN_URL}/tr:${tr}${path}`;
        }

        // Helper function to generate srcset for responsive images
        function generateSrcset(path, sizes, quality = 85) {
            return sizes.map(width =>
                `${getImageUrl(path, { width, quality, format: 'auto' })} ${width}w`
            ).join(', ');
        }

        // Preload next image for faster navigation
        function preloadNextImage() {
            const album = state.albums[state.currentAlbum];
            if (!album || state.currentPhoto >= album.photos.length) return;

            const nextPhoto = album.photos[state.currentPhoto]; // +1 since array is 0-indexed
            if (!nextPhoto) return;

            const nextPhotoFilename = typeof nextPhoto === 'string' ? nextPhoto : nextPhoto.filename;
            const nextPhotoPath = `/albums/${state.currentAlbum}/${nextPhotoFilename}`;

            // Create link element for preloading
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.as = 'image';
            link.imageSrcset = generateSrcset(nextPhotoPath, [800, 1200, 1920, 2560, 3840], 100);
            link.imageSizes = '100vw';

            document.head.appendChild(link);
        }

        let state = {
            view: 'index',
            currentAlbum: null,
            currentPhoto: 1,
            albums: {},
            sortBy: 'date' // 'name', 'date', 'count'
        };

        // Parse URL hash to restore state
        function parseHash() {
            const hash = window.location.hash.slice(1); // Remove the #
            if (!hash) {
                // No hash means we're at the index
                state.view = 'index';
                state.currentAlbum = null;
                state.currentPhoto = 1;
                return;
            }

            const parts = hash.split('/');
            if (parts.length === 2) {
                const [encodedAlbumId, photoNum] = parts;
                const albumId = decodeURIComponent(encodedAlbumId);
                const photoNumber = parseInt(photoNum, 10);

                if (state.albums[albumId] && photoNumber > 0) {
                    state.currentAlbum = albumId;
                    state.currentPhoto = Math.min(photoNumber, state.albums[albumId].photos.length);
                    state.view = 'viewer';
                }
            }
        }

        // Update URL hash when state changes
        function updateHash() {
            if (state.view === 'viewer' && state.currentAlbum) {
                window.location.hash = `${encodeURIComponent(state.currentAlbum)}/${state.currentPhoto}`;
            } else {
                window.location.hash = '';
            }
        }

        // Load albums from folders
        async function loadAlbums() {
            try {
                // Fetch the albums list
                const response = await fetch('./albums/albums.json', { cache: 'no-store' });
                const albumsList = await response.json();

                // Load each album's photos
                for (const albumId of albumsList.albums) {
                    try {
                        const photosResponse = await fetch(`./albums/${albumId}/photos.json`, { cache: 'no-store' });
                        const photosData = await photosResponse.json();
                        state.albums[albumId] = {
                            name: photosData.name || albumId,
                            photos: photosData.photos,
                            created: photosData.created || null
                        };
                    } catch (e) {
                        console.error(`Failed to load album ${albumId}:`, e);
                    }
                }

                parseHash(); // Check URL hash after loading albums
                render();
            } catch (e) {
                console.error('Failed to load albums:', e);
                document.getElementById('app').innerHTML = '<p>Error loading albums. Make sure /albums/albums.json exists.</p>';
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'index') {
                app.innerHTML = `
                    <div>
                        <div class="p-6 grid sm:gap-x-16 gap-x-6 md:grid-cols-6 sm:grid-cols-3 grid-cols-2 border-b border-stone-800 dark:border-stone-400">
                          <div class="flex space-x-1 group h-fit">
                            <h1><a href="/" class="hover:underline">Albums</a></h1>
                            <span class="text-stone-500 sm:opacity-0 group-hover:opacity-100">(${Object.keys(state.albums).length})</span>
                          </div>
                          <div class="space-y-1">
                            <span>Sort by:</span>
                            <div>
                                <button id="sort-date" class="block ${state.sortBy === 'date' ? 'underline' : 'hover:underline'}">Date</button>
                                <button id="sort-name" class="block ${state.sortBy === 'name' ? 'underline' : 'hover:underline'}">Name</button>
                                <button id="sort-count" class="block ${state.sortBy === 'count' ? 'underline' : 'hover:underline'}">Count</button>
                            </div>
                          </div>
                        </div>
                        <ul id="album-list" class="p-6 sm:gap-x-16 gap-x-6 gap-y-10 grid md:grid-cols-6 sm:grid-cols-3 grid-cols-2 items-end"></ul>
                        <div class="p-6 border-t border-stone-800 dark:border-stone-400">
                          Â© 2026, All Rights Reserved.
                        </div>
                    </div>
                `;

                const list = document.getElementById('album-list');

                if (Object.keys(state.albums).length === 0) {
                    list.innerHTML = '<li>No albums found</li>';
                    return;
                }

                // Add sorting button handlers
                document.getElementById('sort-name').onclick = () => {
                    state.sortBy = 'name';
                    render();
                };
                document.getElementById('sort-date').onclick = () => {
                    state.sortBy = 'date';
                    render();
                };
                document.getElementById('sort-count').onclick = () => {
                    state.sortBy = 'count';
                    render();
                };

                // Sort albums based on current sort option
                const albumEntries = Object.entries(state.albums);
                albumEntries.sort((a, b) => {
                    const [idA, albumA] = a;
                    const [idB, albumB] = b;

                    if (state.sortBy === 'name') {
                        return albumA.name.localeCompare(albumB.name);
                    } else if (state.sortBy === 'date') {
                        const dateA = albumA.created ? new Date(albumA.created) : new Date(0);
                        const dateB = albumB.created ? new Date(albumB.created) : new Date(0);
                        return dateB - dateA; // Newest first
                    } else if (state.sortBy === 'count') {
                        return albumB.photos.length - albumA.photos.length; // Most photos first
                    }
                    return 0;
                });

                albumEntries.forEach(([id, album]) => {
                    const li = document.createElement('li');
                    li.className = 'group';
                    const a = document.createElement('a');
                    a.href = '#';
                    
                    // Add cover image if available
                    if (album.photos && album.photos.length > 0) {
                        // Get first photo (support both string and object format)
                        const firstPhoto = album.photos[0];
                        const firstPhotoFilename = typeof firstPhoto === 'string' ? firstPhoto : firstPhoto.filename;

                        // Get dimensions if available
                        const coverWidth = (typeof firstPhoto === 'object' && firstPhoto.width) ? firstPhoto.width : null;
                        const coverHeight = (typeof firstPhoto === 'object' && firstPhoto.height) ? firstPhoto.height : null;
                        const coverAspectRatio = (coverWidth && coverHeight) ? `${coverWidth} / ${coverHeight}` : 'auto';

                        // Create container with aspect ratio
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative mb-4';
                        imgContainer.style.aspectRatio = coverAspectRatio;

                        // Add background placeholder
                        const placeholder = document.createElement('div');
                        placeholder.className = 'absolute inset-0 bg-stone-300 dark:bg-stone-700';
                        imgContainer.appendChild(placeholder);

                        const img = document.createElement('img');
                        img.className = 'relative z-10 w-full h-full object-contain group-hover:outline group-hover:outline-stone-800 dark:group-hover:outline-stone-100 outline outline-transparent opacity-0';

                        // Store data for lazy loading
                        img.dataset.srcset = generateSrcset(`/albums/${id}/${firstPhotoFilename}`, [200, 400, 600, 800], 80);
                        img.dataset.sizes = '(max-width: 640px) 50vw, (max-width: 768px) 33vw, 16vw';
                        img.dataset.src = getImageUrl(`/albums/${id}/${firstPhotoFilename}`, {
                            width: 400,
                            quality: 80,
                            format: 'auto'
                        });
                        img.alt = album.name;
                        img.decoding = 'async';

                        // Add fade-in animation after image loads
                        img.onload = () => {
                            img.classList.remove('opacity-0');
                            img.classList.add('animate-fade-in');
                        };

                        imgContainer.appendChild(img);
                        a.appendChild(imgContainer);
                    }
                    
                    const infoWrapper = document.createElement('div');
                    infoWrapper.className = 'flex space-x-1'

                    const title = document.createElement('div');
                    title.textContent = album.name;
                    title.className = 'group-hover:underline';
                    infoWrapper.appendChild(title);


                    // if (album.created) {
                    //     const date = document.createElement('div');
                    //     const dateObj = new Date(album.created);
                    //     date.textContent = dateObj.toLocaleDateString('en-US', {
                    //         year: 'numeric',
                    //         month: 'short',
                    //         day: 'numeric'
                    //     });
                    //     infoWrapper.appendChild(date);
                    // }

                    const count = document.createElement('div');
                    count.className = 'text-stone-500 sm:opacity-0 group-hover:opacity-100'
                    count.textContent = `(${album.photos.length})`;
                    infoWrapper.appendChild(count);

                    a.appendChild(infoWrapper);
                    
                    a.onclick = (e) => {
                        e.preventDefault();
                        openAlbum(id);
                    };

                    // Preload first 3 images on hover
                    a.onmouseenter = () => {
                        if (album.photos && album.photos.length > 0) {
                            const photosToPreload = album.photos.slice(0, 3);
                            photosToPreload.forEach(photo => {
                                const photoFilename = typeof photo === 'string' ? photo : photo.filename;
                                const link = document.createElement('link');
                                link.rel = 'prefetch';
                                link.as = 'image';
                                link.imageSrcset = generateSrcset(`/albums/${id}/${photoFilename}`, [800, 1200, 1920, 2560, 3840], 100);
                                link.imageSizes = '100vw';
                                document.head.appendChild(link);
                            });
                        }
                    };

                    li.appendChild(a);
                    list.appendChild(li);
                });

                // Lazy load images with Intersection Observer
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.srcset = img.dataset.srcset;
                            img.sizes = img.dataset.sizes;
                            img.src = img.dataset.src;
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px'
                });

                document.querySelectorAll('#album-list img').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                const album = state.albums[state.currentAlbum];
                const currentPhoto = album.photos[state.currentPhoto - 1];
                const currentPhotoFilename = typeof currentPhoto === 'string' ? currentPhoto : currentPhoto.filename;
                const isLastPhoto = state.currentPhoto >= album.photos.length;

                // Get dimensions if available
                const photoWidth = (currentPhoto && typeof currentPhoto === 'object' && currentPhoto.width) ? currentPhoto.width : null;
                const photoHeight = (currentPhoto && typeof currentPhoto === 'object' && currentPhoto.height) ? currentPhoto.height : null;
                const aspectRatio = (photoWidth && photoHeight) ? `${photoWidth} / ${photoHeight}` : 'auto';

                console.log('Photo dimensions:', { currentPhoto, photoWidth, photoHeight, aspectRatio });

                const photoPath = `/albums/${state.currentAlbum}/${currentPhotoFilename}`;

                app.innerHTML = `
                    <div>
                        <!-- Loading progress bar -->
                        <div class="fixed top-0 left-0 w-full h-px z-50">
                            <div id="loading-bar" class="h-full bg-stone-200 dark:bg-stone-800 transition-all duration-150" style="width: 0%"></div>
                        </div>

                        <div class="absolute bottom-0 w-full flex place-content-between px-6 py-4">
                            <div class="flex space-x-1">
                              <button id="back-btn" class="hover:underline block">
                                Albums
                              </button>
                              <span class="text-stone-500">/</span>
                              <h2>${album.name}</h2>
                            </div>
                            <p>${state.currentPhoto} <span class="text-stone-500">/</span> ${album.photos.length}</p>
                        </div>
                        <div class="w-full h-dvh md:p-24 sm:p-12 p-6">
                          <div class="w-full h-full flex items-center justify-center">
                            <div class="relative h-full" style="aspect-ratio: ${aspectRatio}; max-width: 100%; max-height: 100%;">
                              <div class="absolute inset-0 bg-stone-300 dark:bg-stone-700"></div>
                              <img
                                  class="relative z-10 w-full h-full object-contain opacity-0"
                                  id="photo-img"
                                  srcset="${generateSrcset(photoPath, [800, 1200, 1920, 2560, 3840], 100)}"
                                  sizes="100vw"
                                  src="${getImageUrl(photoPath, { width: 1920, quality: 100, format: 'auto' })}"
                                  alt="Photo ${state.currentPhoto}"
                                  style="cursor: pointer"
                                  loading="eager"
                                  decoding="async"
                              />
                            </div>
                          </div>
                        </div>
                        <!-- ${isLastPhoto ? '<p>End of album - click photo to return</p>' : ''} -->
                    </div>
                `;

                document.getElementById('back-btn').onclick = backToIndex;

                const photoImg = document.getElementById('photo-img');
                const loadingBar = document.getElementById('loading-bar');

                // Optimized: let browser load natively, simulate smooth progress
                let progress = 0;
                let progressSpeed = 15; // Start fast

                const progressInterval = setInterval(() => {
                    // Slow down as we get closer to 90%
                    if (progress > 70) progressSpeed = 3;
                    else if (progress > 50) progressSpeed = 8;

                    progress += progressSpeed;
                    if (progress > 90) progress = 90;
                    loadingBar.style.width = `${progress}%`;
                }, 50);

                // Complete on actual image load
                photoImg.onload = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';

                    setTimeout(() => {
                        loadingBar.style.opacity = '0';
                    }, 150);

                    photoImg.classList.remove('opacity-0');
                    photoImg.classList.add('animate-fade-in');
                };

                photoImg.onerror = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';
                    loadingBar.classList.remove('bg-black');
                    loadingBar.classList.add('bg-red-500');
                };

                if (isLastPhoto) {
                    photoImg.onclick = backToIndex;
                } else {
                    photoImg.onclick = nextPhoto;
                }

                // Preload the next image for instant navigation
                preloadNextImage();
            }
        }

        function openAlbum(albumId) {
            state.currentAlbum = albumId;
            state.currentPhoto = 1;
            state.view = 'viewer';
            updateHash();
            render();
        }

        function nextPhoto() {
            const album = state.albums[state.currentAlbum];
            if (state.currentPhoto < album.photos.length) {
                state.currentPhoto++;
                updateHash();
                render();
            }
        }

        function backToIndex() {
            state.view = 'index';
            state.currentAlbum = null;
            state.currentPhoto = 1;
            updateHash();
            render();
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            parseHash();
            render();
        });

        // Handle keyboard navigation
        window.addEventListener('keydown', (e) => {
            if (state.view !== 'viewer') return;

            const album = state.albums[state.currentAlbum];

            if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (state.currentPhoto >= album.photos.length) {
                    backToIndex();
                } else {
                    nextPhoto();
                }
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (state.currentPhoto === 1) {
                    backToIndex();
                } else {
                    state.currentPhoto--;
                    updateHash();
                    render();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                backToIndex();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                backToIndex();
            }
        });

        // Handle touch/swipe gestures
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        window.addEventListener('touchstart', (e) => {
            if (state.view !== 'viewer') return;
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        window.addEventListener('touchend', (e) => {
            if (state.view !== 'viewer') return;

            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;

            const album = state.albums[state.currentAlbum];
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Minimum swipe distance to trigger action (50px)
            const minSwipeDistance = 50;

            // Determine if horizontal or vertical swipe
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe right (previous photo or back to index)
                        if (state.currentPhoto === 1) {
                            backToIndex();
                        } else {
                            state.currentPhoto--;
                            updateHash();
                            render();
                        }
                    } else {
                        // Swipe left (next photo or back to index)
                        if (state.currentPhoto >= album.photos.length) {
                            backToIndex();
                        } else {
                            nextPhoto();
                        }
                    }
                }
            } else {
                // Vertical swipe
                if (deltaY < -minSwipeDistance) {
                    // Swipe up - back to index
                    backToIndex();
                }
            }
        });

        // Initial load
        loadAlbums();
    </script>
</body>
</html>
