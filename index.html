<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Albums</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-in'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-stone-100">
    <div id="app"></div>

    <script>
        // Configuration - ImageKit endpoint
        const IMAGE_CDN_URL = 'https://ik.imagekit.io/splitfocus/albums';

        // Helper function for ImageKit transformations
        function getImageUrl(path, options = {}) {
            const {
                width = null,
                height = null,
                quality = 85,
                format = 'auto',
            } = options;

            const transformations = [];
            if (width) transformations.push(`w-${width}`);
            if (height) transformations.push(`h-${height}`);
            transformations.push(`q-${quality}`);
            transformations.push(`f-${format}`);

            const tr = transformations.join(',');
            return `${IMAGE_CDN_URL}/tr:${tr}${path}`;
        }

        // Helper function to generate srcset for responsive images
        function generateSrcset(path, sizes, quality = 85) {
            return sizes.map(width =>
                `${getImageUrl(path, { width, quality, format: 'auto' })} ${width}w`
            ).join(', ');
        }

        // Preload next image for faster navigation
        function preloadNextImage() {
            const album = state.albums[state.currentAlbum];
            if (!album || state.currentPhoto >= album.photos.length) return;

            const nextPhotoFilename = album.photos[state.currentPhoto]; // +1 since array is 0-indexed
            if (!nextPhotoFilename) return;

            const nextPhotoPath = `/albums/${state.currentAlbum}/${nextPhotoFilename}`;

            // Create link element for preloading
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.as = 'image';
            link.href = getImageUrl(nextPhotoPath, { width: 1920, quality: 100, format: 'auto' });

            // Also preload srcset sizes
            link.imageSrcset = generateSrcset(nextPhotoPath, [800, 1200, 1920, 2560, 3840], 90);

            document.head.appendChild(link);
        }

        let state = {
            view: 'index',
            currentAlbum: null,
            currentPhoto: 1,
            albums: {}
        };

        // Parse URL hash to restore state
        function parseHash() {
            const hash = window.location.hash.slice(1); // Remove the #
            if (!hash) return;

            const parts = hash.split('/');
            if (parts.length === 2) {
                const [encodedAlbumId, photoNum] = parts;
                const albumId = decodeURIComponent(encodedAlbumId);
                const photoNumber = parseInt(photoNum, 10);

                if (state.albums[albumId] && photoNumber > 0) {
                    state.currentAlbum = albumId;
                    state.currentPhoto = Math.min(photoNumber, state.albums[albumId].photos.length);
                    state.view = 'viewer';
                }
            }
        }

        // Update URL hash when state changes
        function updateHash() {
            if (state.view === 'viewer' && state.currentAlbum) {
                window.location.hash = `${encodeURIComponent(state.currentAlbum)}/${state.currentPhoto}`;
            } else {
                window.location.hash = '';
            }
        }

        // Load albums from folders
        async function loadAlbums() {
            try {
                // Fetch the albums list
                const response = await fetch('./albums/albums.json');
                const albumsList = await response.json();
                
                // Load each album's photos
                for (const albumId of albumsList.albums) {
                    try {
                        const photosResponse = await fetch(`./albums/${albumId}/photos.json`);
                        const photosData = await photosResponse.json();
                        state.albums[albumId] = {
                            name: photosData.name || albumId,
                            photos: photosData.photos,
                            created: photosData.created || null
                        };
                    } catch (e) {
                        console.error(`Failed to load album ${albumId}:`, e);
                    }
                }

                parseHash(); // Check URL hash after loading albums
                render();
            } catch (e) {
                console.error('Failed to load albums:', e);
                document.getElementById('app').innerHTML = '<p>Error loading albums. Make sure /albums/albums.json exists.</p>';
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'index') {
                app.innerHTML = `
                    <div>
                        <ul id="album-list" class="grid md:grid-cols-6 sm:grid-cols-3 grid-cols-2 p-4 text-xs items-end"></ul>
                    </div>
                `;
                
                const list = document.getElementById('album-list');
                
                if (Object.keys(state.albums).length === 0) {
                    list.innerHTML = '<li>No albums found</li>';
                    return;
                }
                
                Object.entries(state.albums).forEach(([id, album]) => {
                    const li = document.createElement('li');
                    li.className = 'p-4 group';
                    const a = document.createElement('a');
                    a.href = '#';
                    
                    // Add cover image if available
                    if (album.photos && album.photos.length > 0) {
                        const img = document.createElement('img');
                        img.className = 'mb-2 group-hover:border group-hover:border-black border border-transparent opacity-0';

                        // Responsive srcset for thumbnails
                        img.srcset = generateSrcset(`/albums/${id}/${album.photos[0]}`, [200, 400, 600, 800], 80);
                        img.sizes = '(max-width: 640px) 50vw, (max-width: 768px) 33vw, 16vw';

                        // Fallback src
                        img.src = getImageUrl(`/albums/${id}/${album.photos[0]}`, {
                            width: 400,
                            quality: 80,
                            format: 'auto'
                        });
                        img.alt = album.name;
                        img.decoding = 'async';

                        // Add fade-in animation after image loads
                        img.onload = () => {
                            img.classList.remove('opacity-0');
                            img.classList.add('animate-fade-in');
                        };

                        a.appendChild(img);
                    }
                    
                    const title = document.createElement('div');
                    title.textContent = album.name;
                    title.className = 'group-hover:underline';
                    a.appendChild(title);
                    
                    
                    if (album.created) {
                        const date = document.createElement('div');
                        const dateObj = new Date(album.created);
                        date.textContent = dateObj.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        a.appendChild(date);
                    }

                    const count = document.createElement('div');
                    count.textContent = `(${album.photos.length})`;
                    a.appendChild(count);
                    
                    a.onclick = (e) => {
                        e.preventDefault();
                        openAlbum(id);
                    };
                    li.appendChild(a);
                    list.appendChild(li);
                });
            } else {
                const album = state.albums[state.currentAlbum];
                const currentPhotoFilename = album.photos[state.currentPhoto - 1];
                const isLastPhoto = state.currentPhoto >= album.photos.length;

                const photoPath = `/albums/${state.currentAlbum}/${currentPhotoFilename}`;

                app.innerHTML = `
                    <div>
                        <div class="absolute bottom-0 w-full flex place-content-between text-xs px-6 py-4">
                            <button id="back-btn">‚Üê</button>
                            <h2>${album.name}</h2>
                            <p>(${state.currentPhoto}/${album.photos.length})</p>
                        </div>
                        <div class="w-full h-dvh justify-items-center items-center grid">
                            <img
                                class="max-h-dvh md:p-24 sm:p-12 p-6 opacity-0"
                                id="photo-img"
                                srcset="${generateSrcset(photoPath, [800, 1200, 1920, 2560, 3840], 90)}"
                                sizes="100vw"
                                src="${getImageUrl(photoPath, { width: 1920, quality: 100, format: 'auto' })}"
                                alt="Photo ${state.currentPhoto}"
                                style="cursor: pointer"
                                loading="eager"
                                decoding="async"
                            />
                        </div>
                        <!-- ${isLastPhoto ? '<p>End of album - click photo to return</p>' : ''} -->
                    </div>
                `;

                document.getElementById('back-btn').onclick = backToIndex;

                const photoImg = document.getElementById('photo-img');

                // Add fade-in animation after image loads
                photoImg.onload = () => {
                    photoImg.classList.remove('opacity-0');
                    photoImg.classList.add('animate-fade-in');
                };

                if (isLastPhoto) {
                    photoImg.onclick = backToIndex;
                } else {
                    photoImg.onclick = nextPhoto;
                }

                // Preload the next image for instant navigation
                preloadNextImage();
            }
        }

        function openAlbum(albumId) {
            state.currentAlbum = albumId;
            state.currentPhoto = 1;
            state.view = 'viewer';
            updateHash();
            render();
        }

        function nextPhoto() {
            const album = state.albums[state.currentAlbum];
            if (state.currentPhoto < album.photos.length) {
                state.currentPhoto++;
                updateHash();
                render();
            }
        }

        function backToIndex() {
            state.view = 'index';
            state.currentAlbum = null;
            state.currentPhoto = 1;
            updateHash();
            render();
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            parseHash();
            render();
        });

        // Initial load
        loadAlbums();
    </script>
</body>
</html>
