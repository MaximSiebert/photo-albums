<!DOCTYPE html>
<html lang="en" class=""dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Albums</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in .6s ease-in'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-stone-200 dark:bg-stone-900 text-stone-800 dark:text-stone-200 text-[11px]">
    <div id="app"></div>

    <script>
        // Configuration - ImageKit endpoint
        const IMAGE_CDN_URL = 'https://ik.imagekit.io/splitfocus/albums';

        // Helper function for ImageKit transformations
        function getImageUrl(path, options = {}) {
            const {
                width = null,
                height = null,
                quality = 85,
                format = 'auto',
            } = options;

            const transformations = [];
            if (width) transformations.push(`w-${width}`);
            if (height) transformations.push(`h-${height}`);
            transformations.push(`q-${quality}`);
            transformations.push(`f-${format}`);

            const tr = transformations.join(',');
            return `${IMAGE_CDN_URL}/tr:${tr}${path}`;
        }

        // Helper function to generate srcset for responsive images
        function generateSrcset(path, sizes, quality = 85) {
            return sizes.map(width =>
                `${getImageUrl(path, { width, quality, format: 'auto' })} ${width}w`
            ).join(', ');
        }

        // Preload next image for faster navigation
        function preloadNextImage() {
            const album = state.albums[state.currentAlbum];
            if (!album || state.currentPhoto >= album.photos.length) return;

            const nextPhotoFilename = album.photos[state.currentPhoto]; // +1 since array is 0-indexed
            if (!nextPhotoFilename) return;

            const nextPhotoPath = `/albums/${state.currentAlbum}/${nextPhotoFilename}`;

            // Create link element for preloading
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.as = 'image';
            link.imageSrcset = generateSrcset(nextPhotoPath, [800, 1200, 1920, 2560, 3840], 100);
            link.imageSizes = '100vw';

            document.head.appendChild(link);
        }

        let state = {
            view: 'index',
            currentAlbum: null,
            currentPhoto: 1,
            albums: {}
        };

        // Parse URL hash to restore state
        function parseHash() {
            const hash = window.location.hash.slice(1); // Remove the #
            if (!hash) {
                // No hash means we're at the index
                state.view = 'index';
                state.currentAlbum = null;
                state.currentPhoto = 1;
                return;
            }

            const parts = hash.split('/');
            if (parts.length === 2) {
                const [encodedAlbumId, photoNum] = parts;
                const albumId = decodeURIComponent(encodedAlbumId);
                const photoNumber = parseInt(photoNum, 10);

                if (state.albums[albumId] && photoNumber > 0) {
                    state.currentAlbum = albumId;
                    state.currentPhoto = Math.min(photoNumber, state.albums[albumId].photos.length);
                    state.view = 'viewer';
                }
            }
        }

        // Update URL hash when state changes
        function updateHash() {
            if (state.view === 'viewer' && state.currentAlbum) {
                window.location.hash = `${encodeURIComponent(state.currentAlbum)}/${state.currentPhoto}`;
            } else {
                window.location.hash = '';
            }
        }

        // Load albums from folders
        async function loadAlbums() {
            try {
                // Fetch the albums list
                const response = await fetch('./albums/albums.json');
                const albumsList = await response.json();
                
                // Load each album's photos
                for (const albumId of albumsList.albums) {
                    try {
                        const photosResponse = await fetch(`./albums/${albumId}/photos.json`);
                        const photosData = await photosResponse.json();
                        state.albums[albumId] = {
                            name: photosData.name || albumId,
                            photos: photosData.photos,
                            created: photosData.created || null
                        };
                    } catch (e) {
                        console.error(`Failed to load album ${albumId}:`, e);
                    }
                }

                parseHash(); // Check URL hash after loading albums
                render();
            } catch (e) {
                console.error('Failed to load albums:', e);
                document.getElementById('app').innerHTML = '<p>Error loading albums. Make sure /albums/albums.json exists.</p>';
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'index') {
                app.innerHTML = `
                    <div>
                        <ul id="album-list" class="gap-x-8 gap-y-10 grid md:grid-cols-6 sm:grid-cols-3 grid-cols-2 md:px-6 sm:px-4 px-3 py-12 items-end"></ul>
                    </div>
                `;
                
                const list = document.getElementById('album-list');
                
                if (Object.keys(state.albums).length === 0) {
                    list.innerHTML = '<li>No albums found</li>';
                    return;
                }
                
                Object.entries(state.albums).forEach(([id, album]) => {
                    const li = document.createElement('li');
                    li.className = 'md:p-6 sm:p-4 p-3 group';
                    const a = document.createElement('a');
                    a.href = '#';
                    
                    // Add cover image if available
                    if (album.photos && album.photos.length > 0) {
                        const img = document.createElement('img');
                        img.className = 'mb-4 group-hover:border group-hover:border-stone-800 border border-transparent opacity-0';

                        // Responsive srcset for thumbnails
                        img.srcset = generateSrcset(`/albums/${id}/${album.photos[0]}`, [200, 400, 600, 800], 80);
                        img.sizes = '(max-width: 640px) 50vw, (max-width: 768px) 33vw, 16vw';

                        // Fallback src
                        img.src = getImageUrl(`/albums/${id}/${album.photos[0]}`, {
                            width: 400,
                            quality: 80,
                            format: 'auto'
                        });
                        img.alt = album.name;
                        img.decoding = 'async';

                        // Add fade-in animation after image loads
                        img.onload = () => {
                            img.classList.remove('opacity-0');
                            img.classList.add('animate-fade-in');
                        };

                        a.appendChild(img);
                    }
                    
                    const title = document.createElement('div');
                    title.textContent = album.name;
                    title.className = 'group-hover:underline';
                    a.appendChild(title);
                    
                    
                    // if (album.created) {
                    //     const date = document.createElement('div');
                    //     const dateObj = new Date(album.created);
                    //     date.textContent = dateObj.toLocaleDateString('en-US', { 
                    //         year: 'numeric', 
                    //         month: 'short', 
                    //         day: 'numeric' 
                    //     });
                    //     a.appendChild(date);
                    // }

                    const count = document.createElement('div');
                    count.className = 'text-stone-500'
                    count.textContent = `(${album.photos.length})`;
                    a.appendChild(count);
                    
                    a.onclick = (e) => {
                        e.preventDefault();
                        openAlbum(id);
                    };

                    // Preload first 3 images on hover
                    a.onmouseenter = () => {
                        if (album.photos && album.photos.length > 0) {
                            const photosToPreload = album.photos.slice(0, 3);
                            photosToPreload.forEach(photoFilename => {
                                const link = document.createElement('link');
                                link.rel = 'prefetch';
                                link.as = 'image';
                                link.imageSrcset = generateSrcset(`/albums/${id}/${photoFilename}`, [800, 1200, 1920, 2560, 3840], 100);
                                link.imageSizes = '100vw';
                                document.head.appendChild(link);
                            });
                        }
                    };

                    li.appendChild(a);
                    list.appendChild(li);
                });
            } else {
                const album = state.albums[state.currentAlbum];
                const currentPhotoFilename = album.photos[state.currentPhoto - 1];
                const isLastPhoto = state.currentPhoto >= album.photos.length;

                const photoPath = `/albums/${state.currentAlbum}/${currentPhotoFilename}`;

                app.innerHTML = `
                    <div>
                        <!-- Loading progress bar -->
                        <div class="fixed top-0 left-0 w-full h-px z-50">
                            <div id="loading-bar" class="h-full bg-stone-200 dark:bg-stone-800 transition-all duration-150" style="width: 0%"></div>
                        </div>

                        <div class="absolute bottom-0 w-full flex place-content-between px-6 py-4">
                            <div class="flex">
                              <button id="back-btn" class="mr-2">
                                <svg viewBox="-0.5 -0.5 9 9" xmlns="http://www.w3.org/2000/svg" id="Arrow-Left--Streamline-Ultimate" height="9" width="9">
                                  <desc>
                                    Arrow Left Streamline Icon: https://streamlinehq.com
                                  </desc>
                                  <path d="m0.2523333333333333 4 7.495333333333333 0" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"></path>
                                  <path d="M4.2476666666666665 0.3333333333333333 0.3666666666666667 3.7496666666666667a0.3333333333333333 0.3333333333333333 0 0 0 0 0.5L4.2476666666666665 7.666666666666666" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"></path>
                                </svg>
                              </button>
                              <h2>${album.name}</h2>
                            </div>
                            <p>(${state.currentPhoto}/${album.photos.length})</p>
                        </div>
                        <div class="w-full h-dvh md:p-24 sm:p-12 p-6">
                            <div class="w-full h-full flex items-center justify-center">
                                <img
                                    class="max-w-full max-h-full object-contain opacity-0"
                                    id="photo-img"
                                    srcset="${generateSrcset(photoPath, [800, 1200, 1920, 2560, 3840], 100)}"
                                    sizes="100vw"
                                    src="${getImageUrl(photoPath, { width: 1920, quality: 100, format: 'auto' })}"
                                    alt="Photo ${state.currentPhoto}"
                                    style="cursor: pointer"
                                    loading="eager"
                                    decoding="async"
                                />
                            </div>
                        </div>
                        <!-- ${isLastPhoto ? '<p>End of album - click photo to return</p>' : ''} -->
                    </div>
                `;

                document.getElementById('back-btn').onclick = backToIndex;

                const photoImg = document.getElementById('photo-img');
                const loadingBar = document.getElementById('loading-bar');

                // Optimized: let browser load natively, simulate smooth progress
                let progress = 0;
                let progressSpeed = 15; // Start fast

                const progressInterval = setInterval(() => {
                    // Slow down as we get closer to 90%
                    if (progress > 70) progressSpeed = 3;
                    else if (progress > 50) progressSpeed = 8;

                    progress += progressSpeed;
                    if (progress > 90) progress = 90;
                    loadingBar.style.width = `${progress}%`;
                }, 50);

                // Complete on actual image load
                photoImg.onload = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';

                    setTimeout(() => {
                        loadingBar.style.opacity = '0';
                    }, 150);

                    photoImg.classList.remove('opacity-0');
                    photoImg.classList.add('animate-fade-in');
                };

                photoImg.onerror = () => {
                    clearInterval(progressInterval);
                    loadingBar.style.width = '100%';
                    loadingBar.classList.remove('bg-black');
                    loadingBar.classList.add('bg-red-500');
                };

                if (isLastPhoto) {
                    photoImg.onclick = backToIndex;
                } else {
                    photoImg.onclick = nextPhoto;
                }

                // Preload the next image for instant navigation
                preloadNextImage();
            }
        }

        function openAlbum(albumId) {
            state.currentAlbum = albumId;
            state.currentPhoto = 1;
            state.view = 'viewer';
            updateHash();
            render();
        }

        function nextPhoto() {
            const album = state.albums[state.currentAlbum];
            if (state.currentPhoto < album.photos.length) {
                state.currentPhoto++;
                updateHash();
                render();
            }
        }

        function backToIndex() {
            state.view = 'index';
            state.currentAlbum = null;
            state.currentPhoto = 1;
            updateHash();
            render();
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            parseHash();
            render();
        });

        // Handle keyboard navigation
        window.addEventListener('keydown', (e) => {
            if (state.view !== 'viewer') return;

            const album = state.albums[state.currentAlbum];

            if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (state.currentPhoto >= album.photos.length) {
                    backToIndex();
                } else {
                    nextPhoto();
                }
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (state.currentPhoto === 1) {
                    backToIndex();
                } else {
                    state.currentPhoto--;
                    updateHash();
                    render();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                backToIndex();
            }
        });

        // Initial load
        loadAlbums();
    </script>
</body>
</html>
